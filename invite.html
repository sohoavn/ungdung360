<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tham gia c√¥ng ty - UngDung360</title>
    
    <!-- Font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- VSH CSS Framework -->
    <link rel="stylesheet" href="assets/css/vsh-core.css">
    <link rel="stylesheet" href="assets/css/vsh-components.css">
    <link rel="stylesheet" href="assets/css/vsh-layout.css">
    <link rel="stylesheet" href="assets/css/vsh-utilities.css">
    <link rel="stylesheet" href="assets/css/vsh-responsive.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/vsh-config.js"></script>
    <script src="assets/js/vsh-supabase.js"></script>
    <script src="assets/js/vsh-auth.js"></script>
    
    <style>
        .invite-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 20px;
        }
        
        .invite-card {
            width: 100%;
            max-width: 480px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 40px;
            text-align: center;
        }
        
        .invite-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }
        
        .invite-icon--loading {
            background: #f1f5f9;
        }
        
        .invite-icon--success {
            background: #dcfce7;
        }
        
        .invite-icon--error {
            background: #fef2f2;
        }
        
        .invite-icon--info {
            background: #dbeafe;
        }
        
        .invite-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--vsh-text-primary);
            margin-bottom: 12px;
        }
        
        .invite-desc {
            font-size: 16px;
            color: var(--vsh-text-secondary);
            line-height: 1.6;
            margin-bottom: 24px;
        }
        
        .invite-company {
            background: var(--vsh-bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .invite-company__name {
            font-size: 20px;
            font-weight: 600;
            color: var(--vsh-text-primary);
            margin-bottom: 4px;
        }
        
        .invite-company__role {
            font-size: 14px;
            color: var(--vsh-text-secondary);
        }
        
        .invite-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .invite-footer {
            margin-top: 24px;
            font-size: 14px;
            color: var(--vsh-text-tertiary);
        }
        
        .invite-footer a {
            color: var(--vsh-primary);
        }
        
        /* Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: var(--vsh-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="invite-page">
        <div class="invite-card">
            <!-- Loading State -->
            <div id="loadingState">
                <div class="invite-icon invite-icon--loading">
                    <div class="spinner"></div>
                </div>
                <h1 class="invite-title">ƒêang ki·ªÉm tra l·ªùi m·ªùi...</h1>
                <p class="invite-desc">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
            </div>
            
            <!-- Error State -->
            <div id="errorState" style="display: none;">
                <div class="invite-icon invite-icon--error">‚ùå</div>
                <h1 class="invite-title">L·ªùi m·ªùi kh√¥ng h·ª£p l·ªá</h1>
                <p class="invite-desc" id="errorMessage">L·ªùi m·ªùi ƒë√£ h·∫øt h·∫°n ho·∫∑c kh√¥ng t·ªìn t·∫°i.</p>
                <div class="invite-actions">
                    <a href="index.html" class="vsh-btn vsh-btn--primary vsh-btn--lg">
                        V·ªÅ trang ch·ªß
                    </a>
                </div>
            </div>
            
            <!-- Not Logged In State -->
            <div id="notLoggedInState" style="display: none;">
                <div class="invite-icon invite-icon--info">üîê</div>
                <h1 class="invite-title">ƒêƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c</h1>
                <p class="invite-desc">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ho·∫∑c t·∫°o t√†i kho·∫£n ƒë·ªÉ tham gia c√¥ng ty.</p>
                
                <div class="invite-company" id="companyInfoGuest">
                    <div class="invite-company__name" id="companyNameGuest">-</div>
                    <div class="invite-company__role">B·∫°n ƒë∆∞·ª£c m·ªùi v·ªõi vai tr√≤: <strong id="roleNameGuest">-</strong></div>
                </div>
                
                <div class="invite-actions">
                    <a href="" class="vsh-btn vsh-btn--primary vsh-btn--lg" id="loginLink">
                        ƒêƒÉng nh·∫≠p
                    </a>
                    <a href="" class="vsh-btn vsh-btn--outline vsh-btn--lg" id="registerLink">
                        T·∫°o t√†i kho·∫£n m·ªõi
                    </a>
                </div>
                
                <div class="invite-footer">
                    Sau khi ƒëƒÉng nh·∫≠p, b·∫°n s·∫Ω t·ª± ƒë·ªông tham gia c√¥ng ty
                </div>
            </div>
            
            <!-- Logged In - Can Accept -->
            <div id="acceptState" style="display: none;">
                <div class="invite-icon invite-icon--success">üéâ</div>
                <h1 class="invite-title">B·∫°n ƒë∆∞·ª£c m·ªùi tham gia!</h1>
                <p class="invite-desc">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ tham gia c√¥ng ty</p>
                
                <div class="invite-company">
                    <div class="invite-company__name" id="companyName">-</div>
                    <div class="invite-company__role">Vai tr√≤: <strong id="roleName">-</strong></div>
                </div>
                
                <div class="invite-actions">
                    <button class="vsh-btn vsh-btn--success vsh-btn--lg" id="acceptBtn" onclick="acceptInvitation()">
                        ‚úì Tham gia ngay
                    </button>
                    <a href="dashboard/index.html" class="vsh-btn vsh-btn--secondary vsh-btn--lg">
                        ƒê·ªÉ sau
                    </a>
                </div>
            </div>
            
            <!-- Success State -->
            <div id="successState" style="display: none;">
                <div class="invite-icon invite-icon--success">üéä</div>
                <h1 class="invite-title">Ch√†o m·ª´ng b·∫°n!</h1>
                <p class="invite-desc">B·∫°n ƒë√£ tham gia c√¥ng ty th√†nh c√¥ng. H√£y b·∫Øt ƒë·∫ßu l√†m vi·ªác ngay!</p>
                
                <div class="invite-actions">
                    <a href="dashboard/index.html" class="vsh-btn vsh-btn--primary vsh-btn--lg">
                        V√†o Dashboard ‚Üí
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ===== STATE =====
        let invitationData = null;
        let tenantData = null;
        let currentUser = null;
        let token = null;
        
        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ ƒêang x·ª≠ l√Ω l·ªùi m·ªùi...');
            
            // L·∫•y token t·ª´ URL
            const urlParams = new URLSearchParams(window.location.search);
            token = urlParams.get('token');
            
            if (!token) {
                showError('Kh√¥ng t√¨m th·∫•y m√£ l·ªùi m·ªùi trong URL');
                return;
            }
            
            // Ki·ªÉm tra l·ªùi m·ªùi
            await checkInvitation();
        });
        
        // ===== CHECK INVITATION =====
        async function checkInvitation() {
            try {
                const supabase = getSupabase();
                
                // L·∫•y th√¥ng tin l·ªùi m·ªùi
                const { data: invitation, error } = await supabase
                    .from('tenant_invitations')
                    .select(`
                        *,
                        tenants (
                            id,
                            name,
                            code
                        )
                    `)
                    .eq('token', token)
                    .single();
                
                if (error || !invitation) {
                    showError('L·ªùi m·ªùi kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã h·ªßy');
                    return;
                }
                
                // Ki·ªÉm tra tr·∫°ng th√°i
                if (invitation.status !== 'pending') {
                    if (invitation.status === 'accepted') {
                        showError('L·ªùi m·ªùi n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng');
                    } else if (invitation.status === 'expired') {
                        showError('L·ªùi m·ªùi ƒë√£ h·∫øt h·∫°n');
                    } else {
                        showError('L·ªùi m·ªùi ƒë√£ b·ªã h·ªßy');
                    }
                    return;
                }
                
                // Ki·ªÉm tra h·∫øt h·∫°n
                const expiresAt = new Date(invitation.expires_at);
                if (expiresAt < new Date()) {
                    // C·∫≠p nh·∫≠t status th√†nh expired
                    await supabase
                        .from('tenant_invitations')
                        .update({ status: 'expired' })
                        .eq('id', invitation.id);
                    
                    showError('L·ªùi m·ªùi ƒë√£ h·∫øt h·∫°n');
                    return;
                }
                
                invitationData = invitation;
                tenantData = invitation.tenants;
                
                // Ki·ªÉm tra user ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
                currentUser = await VSH_AUTH.getCurrentUser();
                
                if (!currentUser) {
                    showNotLoggedIn();
                } else {
                    showAcceptState();
                }
                
            } catch (err) {
                console.error('L·ªói:', err);
                showError('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }
        
        // ===== SHOW ERROR =====
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        // ===== SHOW NOT LOGGED IN =====
        function showNotLoggedIn() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('notLoggedInState').style.display = 'block';
            
            // Hi·ªÉn th·ªã th√¥ng tin c√¥ng ty
            document.getElementById('companyNameGuest').textContent = tenantData.name;
            document.getElementById('roleNameGuest').textContent = invitationData.role === 'admin' ? 'Qu·∫£n tr·ªã vi√™n' : 'Nh√¢n vi√™n';
            
            // Set redirect links
            const redirectUrl = encodeURIComponent(window.location.href);
            document.getElementById('loginLink').href = `login.html?redirect=${redirectUrl}`;
            document.getElementById('registerLink').href = `register.html?redirect=${redirectUrl}`;
        }
        
        // ===== SHOW ACCEPT STATE =====
        function showAcceptState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('acceptState').style.display = 'block';
            
            // Hi·ªÉn th·ªã th√¥ng tin
            document.getElementById('companyName').textContent = tenantData.name;
            document.getElementById('roleName').textContent = invitationData.role === 'admin' ? 'Qu·∫£n tr·ªã vi√™n' : 'Nh√¢n vi√™n';
        }
        
        // ===== ACCEPT INVITATION =====
        async function acceptInvitation() {
            const btn = document.getElementById('acceptBtn');
            btn.classList.add('vsh-btn--loading');
            btn.disabled = true;
            btn.textContent = 'ƒêang x·ª≠ l√Ω...';
            
            try {
                const supabase = getSupabase();
                
                // G·ªçi function ƒë·ªÉ accept
                const { data, error } = await supabase
                    .rpc('accept_tenant_invitation', {
                        p_token: token,
                        p_user_id: currentUser.id
                    });
                
                if (error) throw error;
                
                const result = data;
                
                if (!result.success) {
                    throw new Error(result.error);
                }
                
                // X√≥a cache tenant c≈©
                localStorage.removeItem('vsh_tenant_id');
                localStorage.removeItem('vsh_tenant_info');
                
                // Hi·ªÉn th·ªã th√†nh c√¥ng
                document.getElementById('acceptState').style.display = 'none';
                document.getElementById('successState').style.display = 'block';
                
            } catch (err) {
                console.error('L·ªói accept:', err);
                btn.classList.remove('vsh-btn--loading');
                btn.disabled = false;
                btn.textContent = '‚úì Tham gia ngay';
                alert('L·ªói: ' + err.message);
            }
        }
    </script>
</body>
</html>
